---

title: geograpy3.locator


keywords: fastai
sidebar: home_sidebar

summary: "The locator module allows to get detailed city information including the region and country of a city from a location string."
description: "The locator module allows to get detailed city information including the region and country of a city from a location string."
nb_path: "locator.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: locator.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LocationManager" class="doc_header"><code>class</code> <code>LocationManager</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L33" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LocationManager</code>(<strong><code>name</code></strong>:<code>str</code>, <strong><code>entityName</code></strong>:<code>str</code>, <strong><code>entityPluralName</code></strong>:<code>str</code>, <strong><code>listName</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>tableName</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>clazz</code></strong>=<em><code>None</code></em>, <strong><code>primaryKey</code></strong>:<code>str</code>=<em><code>None</code></em>, <strong><code>config</code></strong>:<code>StorageConfig</code>=<em><code>None</code></em>, <strong><code>handleInvalidListTypes</code></strong>=<em><code>True</code></em>, <strong><code>filterInvalidListTypes</code></strong>=<em><code>False</code></em>, <strong><code>debug</code></strong>=<em><code>False</code></em>) :: <code>EntityManager</code></p>
</blockquote>
<p>a list of locations</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">LocationManager</span><span class="p">(</span><span class="n">EntityManager</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a list of locations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">entityName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">entityPluralName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">listName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tableName</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clazz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primaryKey</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">handleInvalidListTypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filterInvalidListTypes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name(string): name of this LocationManager</span>
<span class="sd">            entityName(string): entityType to be managed e.g. Country</span>
<span class="sd">            entityPluralName(string): plural of the the entityType e.g. Countries</span>
<span class="sd">            listName(str): the name of the list to hold</span>
<span class="sd">            tableName(str): the name of the table to use</span>
<span class="sd">            config(StorageConfig): the configuration to be used if None a default configuration will be used</span>
<span class="sd">            handleInvalidListTypes(bool): True if invalidListTypes should be converted or filtered</span>
<span class="sd">            filterInvalidListTypes(bool): True if invalidListTypes should be deleted</span>
<span class="sd">            debug(boolean): override debug setting when default of config is used via config=None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span><span class="o">=</span><span class="n">LocationContext</span><span class="o">.</span><span class="n">getDefaultConfig</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                          <span class="n">entityName</span><span class="o">=</span><span class="n">entityName</span><span class="p">,</span>
                          <span class="n">entityPluralName</span><span class="o">=</span><span class="n">entityPluralName</span><span class="p">,</span>
                          <span class="n">listName</span><span class="o">=</span><span class="n">listName</span><span class="p">,</span>
                          <span class="n">clazz</span><span class="o">=</span><span class="n">clazz</span><span class="p">,</span>
                          <span class="n">tableName</span><span class="o">=</span><span class="n">tableName</span><span class="p">,</span>
                          <span class="n">primaryKey</span><span class="o">=</span><span class="n">primaryKey</span><span class="p">,</span>
                          <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                          <span class="n">handleInvalidListTypes</span><span class="o">=</span><span class="n">handleInvalidListTypes</span><span class="p">,</span>
                          <span class="n">filterInvalidListTypes</span><span class="o">=</span><span class="n">filterInvalidListTypes</span><span class="p">,</span>
                          <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">balltree</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locationByWikidataID</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span><span class="o">==</span><span class="n">StoreMode</span><span class="o">.</span><span class="n">SQL</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sqldb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSQLDB</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getBallTuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the BallTuple=BallTree,validList of this location list</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            cache(bool): if True calculate and use a cached version otherwise recalculate on</span>
<span class="sd">            every call of this function</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            BallTree,list: a sklearn.neighbors.BallTree for the given list of locations, list: the valid list of locations</span>
<span class="sd">            list: valid list of locations</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">validList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">balltree</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">coordinatesrad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getList</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">lat</span> <span class="ow">and</span> <span class="n">location</span><span class="o">.</span><span class="n">lon</span><span class="p">:</span>
                    <span class="n">latlonrad</span> <span class="o">=</span> <span class="p">(</span><span class="n">radians</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">radians</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">lon</span><span class="p">))</span>
                    <span class="n">coordinatesrad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">latlonrad</span><span class="p">)</span>
                    <span class="n">validList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ballTuple</span> <span class="o">=</span> <span class="n">BallTree</span><span class="p">(</span><span class="n">coordinatesrad</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;haversine&#39;</span><span class="p">),</span> <span class="n">validList</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ballTuple</span>
    
    <span class="k">def</span> <span class="nf">fromCache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">getListOfDicts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sampleRecordCount</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get me from the cache</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fromCache</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">getListOfDicts</span><span class="p">,</span> <span class="n">sampleRecordCount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locationByWikidataID</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getList</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locationByWikidataID</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">wikidataid</span><span class="p">]</span><span class="o">=</span><span class="n">entry</span>

    <span class="k">def</span> <span class="nf">getLocationByID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wikidataID</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the location object that corresponds to the given location</span>
<span class="sd">        Args:</span>
<span class="sd">            wikidataID: wikidataid of the location that should be returned</span>
<span class="sd">        Returns:</span>
<span class="sd">            Location object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">location</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">wikidataID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">locationByWikidataID</span><span class="p">:</span>
            <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">locationByWikidataID</span><span class="p">[</span><span class="n">wikidataID</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">location</span>
    
    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">location</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        add the given location to me </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            location(object): the location to be added and put in my hash map</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getList</span><span class="p">()</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">locationByWikidataID</span><span class="p">[</span><span class="n">location</span><span class="o">.</span><span class="n">wikidataid</span><span class="p">]</span><span class="o">=</span><span class="n">location</span>

    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getBackupDirectory</span><span class="p">():</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">(),</span> <span class="s2">&quot;.geograpy3&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">path</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">downloadBackupFileFromGitHub</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">fileName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">targetDirectory</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        download the given fileName from the github data directory</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName(str): the filename to download</span>
<span class="sd">            targetDirectory(str): download the file this directory</span>
<span class="sd">            force(bool): force the overwriting of the existent file</span>
<span class="sd">        </span>
<span class="sd">        Return:</span>
<span class="sd">            str: the local file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Data is downloaded from the github wiki - to modify the data clone the wiki</span>
        <span class="c1"># as documented in https://github.com/somnathrakshit/geograpy3/wiki</span>
        <span class="c1"># git clone https://github.com/somnathrakshit/geograpy3.wiki.git</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/wiki/somnathrakshit/geograpy3/data/</span><span class="si">{</span><span class="n">fileName</span><span class="si">}</span><span class="s2">.gz&quot;</span>
        <span class="k">if</span> <span class="n">targetDirectory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">targetDirectory</span><span class="o">=</span><span class="n">LocationManager</span><span class="o">.</span><span class="n">getBackupDirectory</span><span class="p">()</span>
        <span class="n">backupFile</span> <span class="o">=</span> <span class="n">Download</span><span class="o">.</span><span class="n">downloadBackupFile</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> <span class="n">targetDirectory</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">backupFile</span>

    <span class="k">def</span> <span class="nf">getByName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get locations matching given names</span>
<span class="sd">        Args:</span>
<span class="sd">            name: Name of the location</span>
<span class="sd">        Returns:</span>
<span class="sd">            Returns locations that match the given name</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clazz</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">Lookup WHERE label IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">sqldb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getSQLDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="p">)</span>
        <span class="n">locationRecords</span> <span class="o">=</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
        <span class="n">locations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_locationsFromLookup</span><span class="p">(</span><span class="o">*</span><span class="n">locationRecords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">locations</span>

    <span class="k">def</span> <span class="nf">getLocationsByWikidataId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">wikidataId</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns Location objects for the given wikidataids</span>
<span class="sd">        Args:</span>
<span class="sd">            *wikidataId(str): wikidataIds of the locations that should be returned</span>
<span class="sd">        Returns:</span>
<span class="sd">            Location objects matching the given wikidataids</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wikidataIds</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">wikidataId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wikidataIds</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">wikidataIds</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">query</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;SELECT * FROM </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clazz</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">Lookup WHERE wikidataid IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">wikidataIds</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">sqldb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSQLDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="p">)</span>
        <span class="n">locationRecords</span><span class="o">=</span><span class="n">sqldb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">wikidataIds</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">locationRecords</span><span class="p">:</span>
            <span class="n">locations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_locationsFromLookup</span><span class="p">(</span><span class="o">*</span><span class="n">locationRecords</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">locations</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No Records matching the given wikidataIds found.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_locationsFromLookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">locationRecords</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert given lookup records to the corresponding location objects</span>
<span class="sd">        Args:</span>
<span class="sd">            *locationRecords: lookup records of locations</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of Location objects based on the given records</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clazz</span> <span class="ow">is</span> <span class="n">City</span><span class="p">:</span>
            <span class="n">locations</span><span class="o">=</span><span class="p">[</span><span class="n">City</span><span class="o">.</span><span class="n">fromCityLookup</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">locationRecords</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">clazz</span> <span class="ow">is</span> <span class="n">Region</span><span class="p">:</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Region</span><span class="o">.</span><span class="n">fromRegionLookup</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">locationRecords</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">clazz</span> <span class="ow">is</span> <span class="n">Country</span><span class="p">:</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Country</span><span class="o">.</span><span class="n">fromCountryLookup</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">locationRecords</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">locations</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clazz</span><span class="o">.</span><span class="n">fromRecord</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span> <span class="k">for</span> <span class="n">lr</span> <span class="ow">in</span> <span class="n">locationRecords</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">locations</span>

    <span class="k">def</span> <span class="nf">getLocationByIsoCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isoCode</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get possible locations matching the given isoCode</span>
<span class="sd">        Args:</span>
<span class="sd">            isoCode: isoCode of possible Locations</span>
<span class="sd">        Returns:</span>
<span class="sd">            List of wikidata ids of locations matching the given isoCode</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RegionManager</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">CountryManager</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RegionManager</span><span class="p">):</span>
                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT wikidataid FROM </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tableName</span><span class="si">}</span><span class="s2"> WHERE iso LIKE (?) OR iso LIKE (?)&quot;</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%-</span><span class="si">{</span><span class="n">isoCode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">isoCode</span><span class="p">,)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT wikidataid FROM </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tableName</span><span class="si">}</span><span class="s2"> WHERE iso LIKE (?)&quot;</span>
                <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">isoCode</span><span class="p">,)</span>
            <span class="n">sqldb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSQLDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="p">)</span>
            <span class="n">qres</span> <span class="o">=</span> <span class="n">sqldb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">locationIds</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;wikidataid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">qres</span> <span class="k">if</span> <span class="s1">&#39;wikidataid&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">locationIds</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CountryManager" class="doc_header"><code>class</code> <code>CountryManager</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L232" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CountryManager</code>(<strong><code>name</code></strong>:<code>str</code>=<em><code>'CountryManager'</code></em>, <strong><code>config</code></strong>:<code>StorageConfig</code>=<em><code>None</code></em>, <strong><code>debug</code></strong>=<em><code>False</code></em>) :: <a href="/geograpy_new/locator.html#LocationManager"><code>LocationManager</code></a></p>
</blockquote>
<p>a list of countries</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CountryManager</span><span class="p">(</span><span class="n">LocationManager</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a list of countries</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;CountryManager&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">entityName</span><span class="o">=</span><span class="s2">&quot;country&quot;</span><span class="p">,</span>
                            <span class="n">entityPluralName</span><span class="o">=</span><span class="s2">&quot;countries&quot;</span><span class="p">,</span>
                            <span class="n">clazz</span><span class="o">=</span><span class="n">Country</span><span class="p">,</span>
                            <span class="n">primaryKey</span><span class="o">=</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">,</span>
                            <span class="n">tableName</span><span class="o">=</span><span class="s2">&quot;countries&quot;</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">=</span><span class="n">Wikidata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getListOfDicts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">getCountries</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromErdem</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get country list provided by Erdem Ozkol https://github.com/erdem</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">countryManager</span> <span class="o">=</span> <span class="n">CountryManager</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;countries_erdem&quot;</span><span class="p">)</span>
        <span class="n">countryJsonUrl</span> <span class="o">=</span> <span class="s2">&quot;https://gist.githubusercontent.com/erdem/8c7d26765831d0f9a8c62f02782ae00d/raw/248037cd701af0a4957cce340dabb0fd04e38f4c/countries.json&quot;</span>
        <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">countryJsonUrl</span><span class="p">)</span> <span class="k">as</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">jsonCountryList</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">jsonCountry</span> <span class="ow">in</span> <span class="n">jsonCountryList</span><span class="p">:</span>
                <span class="n">country</span> <span class="o">=</span> <span class="n">Country</span><span class="p">()</span>
                <span class="n">country</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">jsonCountry</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">country</span><span class="o">.</span><span class="n">iso</span> <span class="o">=</span> <span class="n">jsonCountry</span><span class="p">[</span><span class="s1">&#39;country_code&#39;</span><span class="p">]</span>
                <span class="n">country</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">jsonCountry</span><span class="p">[</span><span class="s1">&#39;latlng&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">country</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">jsonCountry</span><span class="p">[</span><span class="s1">&#39;latlng&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">countryManager</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">country</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">countryManager</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="RegionManager" class="doc_header"><code>class</code> <code>RegionManager</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L270" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>RegionManager</code>(<strong><code>name</code></strong>:<code>str</code>=<em><code>'RegionManager'</code></em>, <strong><code>config</code></strong>:<code>StorageConfig</code>=<em><code>None</code></em>, <strong><code>debug</code></strong>=<em><code>False</code></em>) :: <a href="/geograpy_new/locator.html#LocationManager"><code>LocationManager</code></a></p>
</blockquote>
<p>a list of regions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">RegionManager</span><span class="p">(</span><span class="n">LocationManager</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a list of regions</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;RegionManager&quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">entityName</span><span class="o">=</span><span class="s2">&quot;region&quot;</span><span class="p">,</span>
                            <span class="n">entityPluralName</span><span class="o">=</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span>
                            <span class="n">clazz</span><span class="o">=</span><span class="n">Region</span><span class="p">,</span>
                            <span class="n">primaryKey</span><span class="o">=</span><span class="s2">&quot;regionId&quot;</span><span class="p">,</span>
                            <span class="n">tableName</span><span class="o">=</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
                        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">=</span><span class="n">Wikidata</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">_queryRegions</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">getRegions</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">getCityStates</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getListOfDicts</span><span class="o">=</span><span class="n">_queryRegions</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CityManager" class="doc_header"><code>class</code> <code>CityManager</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L292" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CityManager</code>(<strong><code>name</code></strong>:<code>str</code>=<em><code>'CityManager'</code></em>, <strong><code>config</code></strong>:<code>StorageConfig</code>=<em><code>None</code></em>, <strong><code>debug</code></strong>=<em><code>False</code></em>) :: <a href="/geograpy_new/locator.html#LocationManager"><code>LocationManager</code></a></p>
</blockquote>
<p>a list of cities</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CityManager</span><span class="p">(</span><span class="n">LocationManager</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a list of cities</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;CityManager&quot;</span><span class="p">,</span><span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">entityName</span><span class="o">=</span><span class="s2">&quot;city&quot;</span><span class="p">,</span>
                            <span class="n">entityPluralName</span><span class="o">=</span><span class="s2">&quot;cities&quot;</span><span class="p">,</span>
                            <span class="n">clazz</span><span class="o">=</span><span class="n">City</span><span class="p">,</span>
                            <span class="n">primaryKey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">tableName</span><span class="o">=</span><span class="s2">&quot;cities&quot;</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
                        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">=</span><span class="n">Wikidata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getListOfDicts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="o">.</span><span class="n">getCities</span>
       
    <span class="nd">@classmethod</span>    
    <span class="k">def</span> <span class="nf">getJsonFiles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span> 
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the list of the json files that have my data</span>
<span class="sd">        </span>
<span class="sd">        Return:</span>
<span class="sd">            list: a list of json file names</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">jsondir</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">getCachePath</span><span class="p">()</span><span class="si">}</span><span class="s2">/regions&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jsondir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">jsondir</span><span class="p">)</span>
        <span class="n">jsonFiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jsondir</span><span class="si">}</span><span class="s2">/*.json&quot;</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">path</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">jsonFiles</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Earth" class="doc_header"><code>class</code> <code>Earth</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L326" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Earth</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Earth</span><span class="p">:</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">6371.000</span>  <span class="c1"># radius of earth in km</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Location" class="doc_header"><code>class</code> <code>Location</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L330" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Location</code>(<strong>**<code>kwargs</code></strong>) :: <code>JSONAble</code></p>
</blockquote>
<p>Represents a Location</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Location</span><span class="p">(</span><span class="n">JSONAble</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Represents a Location</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getSamples</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">samplesLOD</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Los Angeles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wikidataid&quot;</span><span class="p">:</span> <span class="s2">&quot;Q65&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">34.05223</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">118.24368</span><span class="p">,</span>
            <span class="s2">&quot;partOf&quot;</span><span class="p">:</span> <span class="s2">&quot;US/CA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;locationKind&quot;</span><span class="p">:</span> <span class="s2">&quot;City&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;population&quot;</span><span class="p">:</span> <span class="mi">3976322</span>
        <span class="p">}]</span>
        <span class="k">return</span> <span class="n">samplesLOD</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the great circle distance between two points </span>
<span class="sd">        on the earth (specified in decimal degrees)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># convert decimal degrees to radians </span>
        <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">])</span>
    
        <span class="c1"># haversine formula </span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span> 
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span> 
        <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">asin</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> 
        <span class="k">return</span> <span class="n">c</span> <span class="o">*</span> <span class="n">Earth</span><span class="o">.</span><span class="n">radius</span>

    <span class="k">def</span> <span class="nf">getNClosestLocations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookupLocationManager</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span><span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives a list of up to n locations which have the shortest distance to </span>
<span class="sd">        me as calculated from the given listOfLocations</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            lookupLocationManager(LocationManager): a LocationManager object to use for lookup</span>
<span class="sd">            n(int): the maximum number of closest locations to return </span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: a list of result Location/distance tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">balltree</span><span class="p">,</span> <span class="n">lookupListOfLocations</span> <span class="o">=</span> <span class="n">lookupLocationManager</span><span class="o">.</span><span class="n">getBallTuple</span><span class="p">()</span>
        <span class="c1"># check for n+1 entries since we might have my own record in the lookup list which we&#39;ll ignore late</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">balltree</span><span class="o">.</span><span class="n">query</span><span class="p">([[</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">)]],</span> <span class="n">k</span><span class="o">=</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">resultLocations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balltreeQueryResultToLocationManager</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lookupListOfLocations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resultLocations</span>
        
    <span class="k">def</span> <span class="nf">getLocationsWithinRadius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookupLocationManager</span><span class="p">,</span> <span class="n">radiusKm</span><span class="p">:</span><span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gives the n closest locations to me from the given lookupListOfLocations</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            lookupLocationManager(LocationManager): a LocationManager object to use for lookup</span>
<span class="sd">            radiusKm(float): the radius in which to check (in km)</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: a list of result Location/distance tuples</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">balltree</span><span class="p">,</span> <span class="n">lookupListOfLocations</span> <span class="o">=</span> <span class="n">lookupLocationManager</span><span class="o">.</span><span class="n">getBallTuple</span><span class="p">()</span>
        
        <span class="n">indices</span><span class="p">,</span> <span class="n">distances</span> <span class="o">=</span> <span class="n">balltree</span><span class="o">.</span><span class="n">query_radius</span><span class="p">([[</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">),</span> <span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">)]],</span> <span class="n">r</span><span class="o">=</span><span class="n">radiusKm</span> <span class="o">/</span> <span class="n">Earth</span><span class="o">.</span><span class="n">radius</span><span class="p">,</span>
                                                    <span class="n">return_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">locationList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balltreeQueryResultToLocationManager</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lookupListOfLocations</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">locationList</span>
    
    <span class="k">def</span> <span class="nf">balltreeQueryResultToLocationManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">lookupListOfLocations</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        convert the given ballTree Query Result to a LocationManager</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            distances(list): array of distances</span>
<span class="sd">            indices(list): array of indices</span>
<span class="sd">            lookupListOfLocations(list): a list of valid locations to use for lookup</span>
<span class="sd">            </span>
<span class="sd">        Return:</span>
<span class="sd">            list: a list of result Location/distance tuples</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">locationListWithDistance</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">locationIndex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Earth</span><span class="o">.</span><span class="n">radius</span> 
            <span class="n">location</span> <span class="o">=</span> <span class="n">lookupListOfLocations</span><span class="p">[</span><span class="n">locationIndex</span><span class="p">]</span>
            <span class="c1"># do not add myself or any other equivalent location</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.0001</span><span class="p">:</span>
                <span class="n">locationListWithDistance</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">location</span><span class="p">,</span> <span class="n">distance</span><span class="p">))</span>
        <span class="c1"># sort by distance (Ball tree only does this for one of the queries ...)        </span>
        <span class="n">locationListWithDistance</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">locationListWithDistance</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lwd</span><span class="p">:</span> <span class="n">lwd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">locationListWithDistance</span>

    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        calculate the distance to another Location</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            other(Location): the other location</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            the haversine distance in km</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># see https://stackoverflow.com/questions/4913349/haversine-formula-in-python-bearing-and-distance-between-two-gps-points</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">haversine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">distance</span>

    <span class="k">def</span> <span class="nf">isKnownAs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks if this location is known under the given name</span>
<span class="sd">        Args:</span>
<span class="sd">            name(str): name the location should be checked against</span>
<span class="sd">        Returns:</span>
<span class="sd">            True if the given name is either the name of the location or present in the labels of the location</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">isKnown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                <span class="n">isKnown</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">isKnown</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">isKnown</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">partialDict</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">clazz</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="n">getSamples</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">pDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">pDict</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">mappedDict</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">keyMapList</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">keyMap</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mkey</span><span class="p">,</span> <span class="n">mValue</span> <span class="ow">in</span> <span class="n">keyMapList</span><span class="p">:</span>
            <span class="n">keyMap</span><span class="p">[</span><span class="n">mkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">mValue</span>
        <span class="n">pDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">keyMap</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keyMap</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">pDict</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromRecord</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="n">regionRecord</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create  a location from a dict record</span>
<span class="sd">        Args:</span>
<span class="sd">            regionRecord(dict): the records as returned from a Query</span>
<span class="sd">        Returns:</span>
<span class="sd">            Region: the corresponding region information</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">location</span><span class="o">=</span><span class="bp">cls</span><span class="p">()</span>
        <span class="n">location</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">regionRecord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">location</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="City" class="doc_header"><code>class</code> <code>City</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L489" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>City</code>(<strong>**<code>kwargs</code></strong>) :: <a href="/geograpy_new/locator.html#Location"><code>Location</code></a></p>
</blockquote>
<p>a single city as an object</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">City</span><span class="p">(</span><span class="n">Location</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a single city as an object</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">City</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;locationKind&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;locationKind&#39;</span><span class="p">,</span> <span class="s2">&quot;City&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getSamples</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">samplesLOD</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Los Angeles&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wikidataid&quot;</span><span class="p">:</span> <span class="s2">&quot;Q65&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">34.05223</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">118.24368</span><span class="p">,</span>
            <span class="s2">&quot;geoNameId&quot;</span><span class="p">:</span> <span class="s2">&quot;5368361&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gndId&quot;</span><span class="p">:</span> <span class="s2">&quot;4036361-2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;partOf&quot;</span><span class="p">:</span> <span class="s2">&quot;US/CA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s2">&quot;locationKind&quot;</span><span class="p">:</span> <span class="s2">&quot;City&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pop&quot;</span><span class="p">:</span> <span class="s2">&quot;3976322&quot;</span><span class="p">,</span>
            <span class="s2">&quot;regionId&quot;</span><span class="p">:</span> <span class="s2">&quot;Q99&quot;</span><span class="p">,</span>
            <span class="s2">&quot;countryId&quot;</span><span class="p">:</span> <span class="s2">&quot;Q30&quot;</span>
        <span class="p">}]</span>
        <span class="k">return</span> <span class="n">samplesLOD</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;?&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">country</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromCityLookup</span><span class="p">(</span><span class="n">cityLookupRecord</span><span class="p">:</span><span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create a city from a cityLookupRecord and setting City, Region and Country while at it</span>
<span class="sd">        Args:</span>
<span class="sd">            cityRecord(dict): a map derived from the CityLookup view</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># we create city, region and country from scratch without true</span>
        <span class="c1"># object relational mapping and lookup from the locationContext </span>
        <span class="c1"># this is only useful for small result sets that need no further interlinking</span>
        <span class="n">city</span><span class="o">=</span><span class="n">City</span><span class="p">()</span>
        <span class="c1"># first take all params</span>
        <span class="n">cityRecord</span><span class="o">=</span><span class="n">City</span><span class="o">.</span><span class="n">partialDict</span><span class="p">(</span><span class="n">cityLookupRecord</span><span class="p">,</span><span class="n">City</span><span class="p">)</span>
        <span class="n">city</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">cityRecord</span><span class="p">)</span>

        <span class="n">regionRecord</span><span class="o">=</span><span class="n">City</span><span class="o">.</span><span class="n">mappedDict</span><span class="p">(</span><span class="n">cityLookupRecord</span><span class="p">,</span>
            <span class="p">[(</span><span class="s2">&quot;regionId&quot;</span><span class="p">,</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">),(</span><span class="s2">&quot;regionName&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">),(</span><span class="s2">&quot;regionIso&quot;</span><span class="p">,</span><span class="s2">&quot;iso&quot;</span><span class="p">),(</span><span class="s2">&quot;regionPop&quot;</span><span class="p">,</span><span class="s2">&quot;pop&quot;</span><span class="p">),(</span><span class="s2">&quot;regionLat&quot;</span><span class="p">,</span><span class="s2">&quot;lat&quot;</span><span class="p">),(</span><span class="s2">&quot;regionLon&quot;</span><span class="p">,</span><span class="s2">&quot;lon&quot;</span><span class="p">)])</span>
        <span class="n">city</span><span class="o">.</span><span class="n">region</span><span class="o">=</span><span class="n">Region</span><span class="o">.</span><span class="n">fromRecord</span><span class="p">(</span><span class="n">regionRecord</span><span class="p">)</span>

        <span class="n">countryRecord</span><span class="o">=</span><span class="n">City</span><span class="o">.</span><span class="n">mappedDict</span><span class="p">(</span><span class="n">cityLookupRecord</span><span class="p">,</span>
            <span class="p">[(</span><span class="s2">&quot;countryId&quot;</span><span class="p">,</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">),(</span><span class="s2">&quot;countryName&quot;</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">),(</span><span class="s2">&quot;countryIso&quot;</span><span class="p">,</span><span class="s2">&quot;iso&quot;</span><span class="p">),(</span><span class="s2">&quot;countryLat&quot;</span><span class="p">,</span><span class="s2">&quot;lat&quot;</span><span class="p">),(</span><span class="s2">&quot;countryLon&quot;</span><span class="p">,</span><span class="s2">&quot;lon&quot;</span><span class="p">)])</span>
        <span class="n">city</span><span class="o">.</span><span class="n">country</span><span class="o">=</span><span class="n">Country</span><span class="p">()</span>
        <span class="n">city</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">countryRecord</span><span class="p">)</span>
        <span class="n">city</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">country</span><span class="o">=</span><span class="n">city</span><span class="o">.</span><span class="n">country</span>
        <span class="k">return</span> <span class="n">city</span>
    
    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        set a field value with the given name  to</span>
<span class="sd">        the given record dicts corresponding entry or none</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name(string): the name of the field</span>
<span class="sd">            record(dict): the dict to get the value from</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">country</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span>

    <span class="nd">@country</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">=</span> <span class="n">country</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_region</span>

    <span class="nd">@region</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_region</span> <span class="o">=</span> <span class="n">region</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Region" class="doc_header"><code>class</code> <code>Region</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L584" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Region</code>(<strong>**<code>kwargs</code></strong>) :: <a href="/geograpy_new/locator.html#Location"><code>Location</code></a></p>
</blockquote>
<p>a Region (Subdivision)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Region</span><span class="p">(</span><span class="n">Location</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a Region (Subdivision)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Region</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;locationKind&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;locationKind&#39;</span><span class="p">,</span> <span class="s2">&quot;Region&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getSamples</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">samplesLOD</span> <span class="o">=</span> <span class="p">[{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;California&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wikidataid&quot;</span><span class="p">:</span> <span class="s2">&quot;Q99&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">37.0</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">120.0</span><span class="p">,</span>
            <span class="s2">&quot;partOf&quot;</span><span class="p">:</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;locationKind&quot;</span><span class="p">:</span> <span class="s2">&quot;Region&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;California&quot;</span><span class="p">],</span>
            <span class="s2">&quot;iso&quot;</span><span class="p">:</span> <span class="s2">&quot;US-CA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;country_wikidataid&quot;</span><span class="p">:</span> <span class="s2">&quot;Q30&quot;</span>
        <span class="p">}]</span>
        <span class="k">return</span> <span class="n">samplesLOD</span>
    
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iso</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span> 
        <span class="k">return</span> <span class="n">text</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">country</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span>

    <span class="nd">@country</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">=</span> <span class="n">country</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromRegionLookup</span><span class="p">(</span><span class="n">regionLookupRecord</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create a region from a regionLookupRecord and setting Region and Country while at it</span>
<span class="sd">        Args:</span>
<span class="sd">            regionRecord(dict): a map derived from the CityLookup view</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># we create region and country from scratch without true</span>
        <span class="c1"># object relational mapping and lookup from the locationContext</span>
        <span class="c1"># this is only useful for small result sets that need no further interlinking</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">()</span>
        <span class="c1"># first take all params</span>
        <span class="n">regionRecord</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">partialDict</span><span class="p">(</span><span class="n">regionLookupRecord</span><span class="p">,</span> <span class="n">Region</span><span class="p">)</span>
        <span class="n">region</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">regionRecord</span><span class="p">)</span>
        <span class="n">countryRecord</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">mappedDict</span><span class="p">(</span><span class="n">regionLookupRecord</span><span class="p">,</span>
                                        <span class="p">[(</span><span class="s2">&quot;countryId&quot;</span><span class="p">,</span> <span class="s2">&quot;wikidataid&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;countryName&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;countryIso&quot;</span><span class="p">,</span> <span class="s2">&quot;iso&quot;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s2">&quot;countryLat&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;countryLon&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">)])</span>
        <span class="n">region</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">Country</span><span class="p">()</span>
        <span class="n">region</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">countryRecord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">region</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Country" class="doc_header"><code>class</code> <code>Country</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L648" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Country</code>(<strong><code>lookupSource</code></strong>=<em><code>'sqlDB'</code></em>, <strong>**<code>kwargs</code></strong>) :: <a href="/geograpy_new/locator.html#Location"><code>Location</code></a></p>
</blockquote>
<p>a country</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Country</span><span class="p">(</span><span class="n">Location</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    a country</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookupSource</span><span class="o">=</span><span class="s1">&#39;sqlDB&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        coonstruct me</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Country</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;locationKind&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;locationKind&#39;</span><span class="p">,</span> <span class="s2">&quot;Country&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">getSamples</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">samplesLOD</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
            <span class="s1">&#39;wikidataid&#39;</span><span class="p">:</span> <span class="s1">&#39;Q38&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Italy&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;iso&#39;</span><span class="p">:</span> <span class="s1">&#39;IT&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;pop&#39;</span><span class="p">:</span> <span class="mf">60317000.0</span><span class="p">,</span> 
             <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="mf">42.5</span><span class="p">,</span> 
             <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="mf">12.5</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;United States of America&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wikidataid&quot;</span><span class="p">:</span> <span class="s2">&quot;Q30&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">39.82818</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">98.5795</span><span class="p">,</span>
            <span class="s2">&quot;partOf&quot;</span><span class="p">:</span> <span class="s2">&quot;North America&quot;</span><span class="p">,</span>
            <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;locationKind&quot;</span><span class="p">:</span> <span class="s2">&quot;Country&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">:[</span><span class="s2">&quot;USA&quot;</span><span class="p">,</span> <span class="s2">&quot;US&quot;</span><span class="p">,</span> <span class="s2">&quot;United States of America&quot;</span><span class="p">],</span>
            <span class="s2">&quot;iso&quot;</span><span class="p">:</span><span class="s2">&quot;US&quot;</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="p">}]</span>
        <span class="k">return</span> <span class="n">samplesLOD</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">iso</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span> 
        <span class="k">return</span> <span class="n">text</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fromCountryLookup</span><span class="p">(</span><span class="n">countryLookupRecord</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create a region from a regionLookupRecord and setting Region and Country while at it</span>
<span class="sd">        Args:</span>
<span class="sd">            regionRecord(dict): a map derived from the CityLookup view</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># we create region and country from scratch without true</span>
        <span class="c1"># object relational mapping and lookup from the locationContext</span>
        <span class="c1"># this is only useful for small result sets that need no further interlinking</span>
        <span class="n">country</span> <span class="o">=</span> <span class="n">Country</span><span class="p">()</span>
        <span class="n">countryRecord</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">partialDict</span><span class="p">(</span><span class="n">countryLookupRecord</span><span class="p">,</span> <span class="n">Region</span><span class="p">)</span>
        <span class="n">country</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">countryRecord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">country</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="LocationContext" class="doc_header"><code>class</code> <code>LocationContext</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L709" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>LocationContext</code>(<strong><code>countryManager</code></strong>:<a href="/geograpy_new/locator.html#CountryManager"><code>CountryManager</code></a>, <strong><code>regionManager</code></strong>:<a href="/geograpy_new/locator.html#RegionManager"><code>RegionManager</code></a>, <strong><code>cityManager</code></strong>:<a href="/geograpy_new/locator.html#CityManager"><code>CityManager</code></a>, <strong><code>config</code></strong>:<code>StorageConfig</code>)</p>
</blockquote>
<p>Holds LocationManagers of all hierarchy levels and provides methods to traverse through the levels</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">LocationContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Holds LocationManagers of all hierarchy levels and provides methods to traverse through the levels</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">db_filename</span><span class="o">=</span><span class="s2">&quot;locations.db&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">countryManager</span><span class="p">:</span><span class="n">CountryManager</span><span class="p">,</span> <span class="n">regionManager</span><span class="p">:</span><span class="n">RegionManager</span><span class="p">,</span> <span class="n">cityManager</span><span class="p">:</span><span class="n">CityManager</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        construct me</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            countryManager(CountryManager): the country manager to be used</span>
<span class="sd">            regionManager(RegionManager): the region manager to be used</span>
<span class="sd">            cityManager(CityManager): the city manager to be used</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">countryManager</span> <span class="o">=</span> <span class="n">countryManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regionManager</span> <span class="o">=</span> <span class="n">regionManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cityManager</span> <span class="o">=</span> <span class="n">cityManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locator</span><span class="o">=</span><span class="n">Locator</span><span class="p">(</span><span class="n">storageConfig</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">interlinkLocations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">warnOnDuplicates</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">profile</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Interlinks locations by adding the hierarchy references to the locations</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            warnOnDuplicates(bool): if there are duplicates warn </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">profile</span><span class="o">=</span><span class="n">Profiler</span><span class="p">(</span><span class="s2">&quot;interlinking Locations&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">)</span> 
        <span class="n">duplicates</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_countryLookup</span><span class="p">,</span> <span class="n">_dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countryManager</span><span class="o">.</span><span class="n">getLookup</span><span class="p">(</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">)</span>
        <span class="n">duplicates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_dup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regionLookup</span><span class="p">,</span> <span class="n">_dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regionManager</span><span class="o">.</span><span class="n">getLookup</span><span class="p">(</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">)</span>
        <span class="n">duplicates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_dup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cityLookup</span><span class="p">,</span> <span class="n">_dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cityManager</span><span class="o">.</span><span class="n">getLookup</span><span class="p">(</span><span class="s2">&quot;wikidataid&quot;</span><span class="p">)</span>
        <span class="n">duplicates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_dup</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">warnOnDuplicates</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span><span class="si">}</span><span class="s2"> duplicate wikidataids in the country,region and city managers used&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span>
        <span class="c1"># interlink region with country</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span>
            <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_countryLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="s1">&#39;countryId&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">country</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">Country</span><span class="p">):</span>
                <span class="n">region</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>

        <span class="c1"># interlink city with region and country</span>
        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">:</span>
            <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_countryLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="s1">&#39;countryId&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">country</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">Country</span><span class="p">):</span>
                <span class="n">city</span><span class="o">.</span><span class="n">country</span> <span class="o">=</span> <span class="n">country</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regionLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="s1">&#39;regionId&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
                <span class="n">city</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">_elapsed</span><span class="o">=</span><span class="n">profile</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
  
                
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forceUpdate</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">warnOnDuplicates</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        load my data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">countryManager</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">regionManager</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cityManager</span><span class="p">:</span>
            <span class="n">manager</span><span class="o">.</span><span class="n">fromCache</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">forceUpdate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interlinkLocations</span><span class="p">(</span><span class="n">warnOnDuplicates</span><span class="o">=</span><span class="n">warnOnDuplicates</span><span class="p">)</span>
    

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromCache</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span><span class="n">StorageConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forceUpdate</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Inits a LocationContext form Cache if existent otherwise init cache</span>
<span class="sd">        Args:</span>
<span class="sd">            config(StorageConfig): configuration of the cache if None the default config is used</span>
<span class="sd">            forceUpdate(bool): If True an existent cache will be over written</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">getDefaultConfig</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">Download</span><span class="o">.</span><span class="n">needsDownload</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="p">):</span>
            <span class="n">LocationManager</span><span class="o">.</span><span class="n">downloadBackupFileFromGitHub</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">db_filename</span><span class="p">,</span>
                                                         <span class="n">targetDirectory</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getCachePath</span><span class="p">(),</span>
                                                         <span class="n">force</span><span class="o">=</span><span class="n">forceUpdate</span><span class="p">)</span>
        <span class="n">cityManager</span> <span class="o">=</span> <span class="n">CityManager</span><span class="p">(</span><span class="s2">&quot;cities&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">regionManager</span> <span class="o">=</span> <span class="n">RegionManager</span><span class="p">(</span><span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">countryManager</span> <span class="o">=</span> <span class="n">CountryManager</span><span class="p">(</span><span class="s2">&quot;countries&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">locationContext</span> <span class="o">=</span> <span class="n">LocationContext</span><span class="p">(</span><span class="n">countryManager</span><span class="p">,</span> <span class="n">regionManager</span><span class="p">,</span> <span class="n">cityManager</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">locationContext</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getDefaultConfig</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">StorageConfig</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns default StorageConfig</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">StorageConfig</span><span class="p">(</span><span class="n">cacheFile</span><span class="o">=</span><span class="n">LocationContext</span><span class="o">.</span><span class="n">db_filename</span><span class="p">,</span><span class="n">cacheDirName</span><span class="o">=</span><span class="s2">&quot;geograpy3&quot;</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">getCachePath</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">cacheFile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">config</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">countries</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">countryManager</span><span class="o">.</span><span class="n">getList</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">regions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regionManager</span><span class="o">.</span><span class="n">getList</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cityManager</span><span class="o">.</span><span class="n">getList</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">locateLocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">locations</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get possible locations for the given location names.</span>
<span class="sd">        Current prioritization of the results is city(ordered by population)regioncountry</span>
<span class="sd">        ToDo: Extend the ranking of the results e.g. matching of multiple location parts increase ranking</span>
<span class="sd">        Args:</span>
<span class="sd">            *locations:</span>
<span class="sd">            verbose(bool): If True combinations of locations names are used to improve the search results. (Increases lookup time)</span>
<span class="sd">        Returns:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">locations</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">locations</span> <span class="ow">is</span> <span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">locationParts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">locationPart</span> <span class="ow">in</span> <span class="n">location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                    <span class="n">locationParts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">locationPart</span><span class="p">)</span>
        <span class="c1"># Split locationParts even further</span>
        <span class="n">lp</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">locationPart</span> <span class="ow">in</span> <span class="n">locationParts</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">=</span><span class="n">locationPart</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">lp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
            <span class="c1"># Spliting by space breakes the look up for cities such as &#39;Los Angeles&#39;</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">numberParts</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">numberParts</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">lp</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numberParts</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
                <span class="c1"># if numberParts &gt; 2:</span>
                <span class="c1">#     lp.extend([f&quot;{parts[i]} {parts[i + 1]} {parts[i + 2]}&quot; for i in range(numberParts - 2)])</span>
        <span class="n">locationParts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span>
        <span class="n">locationParts</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">locationParts</span><span class="p">))</span>   <span class="c1"># remove duplicates</span>

        <span class="n">cities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cityManager</span><span class="o">.</span><span class="n">getByName</span><span class="p">(</span><span class="o">*</span><span class="n">locationParts</span><span class="p">)</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regionManager</span><span class="o">.</span><span class="n">getByName</span><span class="p">(</span><span class="o">*</span><span class="n">locationParts</span><span class="p">)</span>
        <span class="n">countries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countryManager</span><span class="o">.</span><span class="n">getByName</span><span class="p">(</span><span class="o">*</span><span class="n">locationParts</span><span class="p">)</span>

        <span class="c1"># remove locations already identified by location in lower hierarchy</span>
        <span class="n">getAttrValues</span><span class="o">=</span><span class="k">lambda</span> <span class="n">locations</span><span class="p">,</span> <span class="n">attr</span><span class="p">:[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">locations</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span>
        <span class="n">excludeRegionIds</span><span class="o">=</span><span class="n">getAttrValues</span><span class="p">(</span><span class="n">cities</span><span class="p">,</span> <span class="s1">&#39;regionId&#39;</span><span class="p">)</span>
        <span class="n">regions</span><span class="o">=</span><span class="p">[</span><span class="n">region</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="s1">&#39;wikidataid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">region</span><span class="o">.</span><span class="n">wikidataid</span> <span class="ow">in</span> <span class="n">excludeRegionIds</span><span class="p">]</span>
        <span class="n">excludeCountryIds</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">getAttrValues</span><span class="p">(</span><span class="n">cities</span><span class="p">,</span> <span class="s2">&quot;countryId&quot;</span><span class="p">),</span> <span class="o">*</span><span class="n">getAttrValues</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="s2">&quot;countryId&quot;</span><span class="p">)]</span>
        <span class="n">countries</span><span class="o">=</span><span class="p">[</span><span class="n">country</span> <span class="k">for</span> <span class="n">country</span> <span class="ow">in</span> <span class="n">countries</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="s1">&#39;wikidataid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">country</span><span class="o">.</span><span class="n">wikidataid</span> <span class="ow">in</span> <span class="n">excludeCountryIds</span><span class="p">]</span>

        <span class="c1"># build final result in the order cityregioncountry</span>
        <span class="n">cities</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;pop&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">cities</span><span class="p">,</span> <span class="o">*</span><span class="n">regions</span><span class="p">,</span> <span class="o">*</span><span class="n">countries</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Locator" class="doc_header"><code>class</code> <code>Locator</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/locator.py#L864" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Locator</code>(<strong><code>db_file</code></strong>=<em><code>None</code></em>, <strong><code>correctMisspelling</code></strong>=<em><code>False</code></em>, <strong><code>storageConfig</code></strong>:<code>StorageConfig</code>=<em><code>None</code></em>, <strong><code>debug</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>location handling</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Locator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    location handling</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># singleton instance</span>
    <span class="n">locator</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">correctMisspelling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storageConfig</span><span class="p">:</span><span class="n">StorageConfig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            db_file(str): the path to the database file</span>
<span class="sd">            correctMispelling(bool): if True correct typical misspellings</span>
<span class="sd">            storageConfig(StorageConfig): the storage Configuration to use</span>
<span class="sd">            debug(bool): if True show debug information</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correctMisspelling</span> <span class="o">=</span> <span class="n">correctMisspelling</span>
        <span class="k">if</span> <span class="n">storageConfig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">storageConfig</span><span class="o">=</span><span class="n">LocationContext</span><span class="o">.</span><span class="n">getDefaultConfig</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storageConfig</span><span class="o">=</span><span class="n">storageConfig</span>
        <span class="k">if</span> <span class="n">db_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storageConfig</span><span class="o">.</span><span class="n">getCachePath</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storageConfig</span><span class="o">.</span><span class="n">cacheFile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="o">=</span><span class="n">db_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="s2">&quot;CityLookup&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadDB</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getAliases</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbVersion</span> <span class="o">=</span> <span class="s2">&quot;2021-08-18 16:15:00&quot;</span>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resetInstance</span><span class="p">():</span>
        <span class="n">Locator</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="kc">None</span>    
    
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getInstance</span><span class="p">(</span><span class="n">correctMisspelling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the singleton instance of the Locator. If parameters are changed on further calls</span>
<span class="sd">        the initial parameters will still be in effect since the original instance will be returned!</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            correctMispelling(bool): if True correct typical misspellings</span>
<span class="sd">            debug(bool): if True show debug information</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">Locator</span><span class="o">.</span><span class="n">locator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Locator</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">Locator</span><span class="p">(</span><span class="n">correctMisspelling</span><span class="o">=</span><span class="n">correctMisspelling</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Locator</span><span class="o">.</span><span class="n">locator</span>

    <span class="k">def</span> <span class="nf">normalizePlaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">places</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        normalize places</span>
<span class="sd">        Args:</span>
<span class="sd">            places(list) a list of places</span>
<span class="sd">        Return:</span>
<span class="sd">            list: stripped and aliased list of places</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nplaces</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places</span><span class="p">:</span>
            <span class="n">place</span> <span class="o">=</span> <span class="n">place</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">place</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">:</span>
                <span class="n">place</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">place</span><span class="p">]</span>
            <span class="n">nplaces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nplaces</span>

    <span class="k">def</span> <span class="nf">locateCity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">places</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        locate a city, region country combination based on the given wordtoken information</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            places(list): a list of places derived by splitting a locality e.g.  &quot;San Francisco, CA&quot;</span>
<span class="sd">            leads to &quot;San Francisco&quot;, &quot;CA&quot;</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            City: a city with country and region details</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># make sure the database is populated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_db</span><span class="p">()</span>
        <span class="n">country</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># loop over all word elements</span>
        <span class="n">places</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalizePlaces</span><span class="p">(</span><span class="n">places</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places</span><span class="p">:</span>
            <span class="n">foundCountry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCountry</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">foundCountry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">country</span> <span class="o">=</span> <span class="n">foundCountry</span>
            <span class="n">foundCities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities_for_name</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
            <span class="n">cities</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">foundCities</span><span class="p">)</span>
            <span class="n">foundRegions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions_for_name</span><span class="p">(</span><span class="n">place</span><span class="p">)</span>
            <span class="n">regions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">foundRegions</span><span class="p">)</span>
        <span class="n">foundCity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">disambiguate</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">cities</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">foundCity</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">isISO</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        check if the given string is an ISO code (ISO 3166-2 code)</span>
<span class="sd">        see https://www.wikidata.org/wiki/Property:P300</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the string might be an ISO Code as per a regexp check</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([A-Z]{1,2}\-)?[0-9A-Z]{1,3}$&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">result</span>
               
    <span class="k">def</span> <span class="nf">disambiguate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">cities</span><span class="p">,</span> <span class="n">byPopulation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        try determining country, regions and city from the potential choices</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            country(Country): a matching country found</span>
<span class="sd">            regions(list): a list of matching Regions found</span>
<span class="sd">            cities(list): a list of matching cities found</span>
<span class="sd">            </span>
<span class="sd">        Return:</span>
<span class="sd">            City: the found city or None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;countries: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">country</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;regions: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cities: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">))</span>
        <span class="n">foundCity</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># is the city information unique?</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">foundCity</span> <span class="o">=</span> <span class="n">cities</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">country</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;city </span><span class="si">%s</span><span class="s2">: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">city</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">city</span><span class="o">.</span><span class="n">country</span><span class="o">.</span><span class="n">iso</span> <span class="o">==</span> <span class="n">country</span><span class="o">.</span><span class="n">iso</span><span class="p">:</span>
                            <span class="n">foundCity</span> <span class="o">=</span> <span class="n">city</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">foundCity</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">city</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">iso</span> <span class="o">==</span> <span class="n">region</span><span class="o">.</span><span class="n">iso</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">city</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">city</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                                <span class="n">foundCity</span> <span class="o">=</span> <span class="n">city</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">foundCity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">foundCity</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">byPopulation</span><span class="p">:</span>
                    <span class="n">foundCity</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cities</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">city</span><span class="p">:</span><span class="mi">0</span> <span class="k">if</span> <span class="n">city</span><span class="o">.</span><span class="n">pop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">city</span><span class="o">.</span><span class="n">pop</span><span class="p">)</span>
                    <span class="k">pass</span>
                    
        <span class="k">return</span> <span class="n">foundCity</span>    
    
    <span class="k">def</span> <span class="nf">cities_for_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cityName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        find cities with the given cityName</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            cityName(string): the potential name of a city</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            a list of city records</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cityRecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">places_by_name</span><span class="p">(</span><span class="n">cityName</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cityRecord</span> <span class="ow">in</span> <span class="n">cityRecords</span><span class="p">:</span>
            <span class="n">cities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">City</span><span class="o">.</span><span class="n">fromCityLookup</span><span class="p">(</span><span class="n">cityRecord</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cities</span>

    <span class="k">def</span> <span class="nf">regions_for_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the regions for the given region_name (which might be an ISO code)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            region_name(string): region name</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            list: the list of cities for this region</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[]</span>    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isISO</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
            <span class="n">columnName</span> <span class="o">=</span> <span class="s2">&quot;iso&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">columnName</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT * from regions WHERE </span><span class="si">{</span><span class="n">columnName</span><span class="si">}</span><span class="s2"> = (?)&quot;</span> 
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">region_name</span><span class="p">,)</span>
        <span class="n">regionRecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">regionRecord</span> <span class="ow">in</span> <span class="n">regionRecords</span><span class="p">:</span>
            <span class="n">regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Region</span><span class="o">.</span><span class="n">fromRecord</span><span class="p">(</span><span class="n">regionRecord</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">regions</span>                     
    
    <span class="k">def</span> <span class="nf">correct_country_misspelling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        correct potential misspellings </span>
<span class="sd">        Args:</span>
<span class="sd">            name(string): the name of the country potentially misspelled</span>
<span class="sd">        Return:</span>
<span class="sd">            string: correct name of unchanged</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cur_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cur_dir</span> <span class="o">+</span> <span class="s2">&quot;/data/ISO3166ErrorDictionary.csv&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">remove_non_ascii</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">is_a_country</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        check if the given string name is a country</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            name(string): the string to check</span>
<span class="sd">        Returns:</span>
<span class="sd">            True: if pycountry thinks the string is a country</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">country</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCountry</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">country</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">result</span>
       
    <span class="k">def</span> <span class="nf">getCountry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the country for the given name    </span>
<span class="sd">        Args:</span>
<span class="sd">            name(string): the name of the country to lookup</span>
<span class="sd">        Returns:     </span>
<span class="sd">            country: the country if one was found or None if not</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isISO</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">query</span><span class="o">=</span><span class="s2">&quot;SELECT * FROM countries WHERE iso = (?)&quot;&quot;&quot;</span>
            <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">name</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">correctMisspelling</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correct_country_misspelling</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">query</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;SELECT * FROM countries </span>
<span class="s2">                WHERE name LIKE (?)</span>
<span class="s2">                OR wikidataid in (SELECT wikidataid FROM country_labels WHERE label LIKE (?))&quot;&quot;&quot;</span>
            <span class="n">params</span><span class="o">=</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">name</span><span class="p">,)</span>
        <span class="n">country</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_db</span><span class="p">()</span>
        <span class="n">countryRecords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">countryRecords</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">country</span><span class="o">=</span><span class="n">Country</span><span class="o">.</span><span class="n">fromRecord</span><span class="p">(</span><span class="n">countryRecords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">country</span>
    
    <span class="k">def</span> <span class="nf">getView</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the view to be used</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str: the SQL view to be used for CityLookups e.g. CityLookup</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span>
        <span class="k">return</span> <span class="n">view</span>
 
    <span class="k">def</span> <span class="nf">places_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placeName</span><span class="p">,</span> <span class="n">columnName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get places by name and column</span>
<span class="sd">        Args:</span>
<span class="sd">            placeName(string): the name of the place</span>
<span class="sd">            columnName(string): the column to look at</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_has_data</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_db</span><span class="p">()</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getView</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM </span><span class="si">{</span><span class="n">view</span><span class="si">}</span><span class="s1"> WHERE </span><span class="si">{</span><span class="n">columnName</span><span class="si">}</span><span class="s1"> = (?) ORDER BY pop DESC&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">placeName</span><span class="p">,)</span>
        <span class="n">cityLookupRecords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">cityLookupRecords</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cityRecord</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">cityRecord</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">))</span> <span class="k">if</span> <span class="n">cityRecord</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pop&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cityLookupRecords</span>
    
     
    <span class="k">def</span> <span class="nf">recreateDatabase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        recreate my lookup database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;recreating database ... </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_db</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
                
    <span class="k">def</span> <span class="nf">populate_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        populate the cities SQL database which caches the information from the GeoLite2-City-Locations.csv file</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            force(bool): if True force a recreation of the database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">hasData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_has_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_Countries</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_Regions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_Cities</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createViews</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_Version</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="p">)</span>
    
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">hasData</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">downloadDB</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">):</span>
            <span class="k">raise</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not create lookup database </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">downloadDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forceUpdate</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        download my database</span>
<span class="sd">        Args:</span>
<span class="sd">            forceUpdate(bool): force the overwriting of the existent file</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">Download</span><span class="o">.</span><span class="n">needsDownload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">)</span> <span class="ow">or</span> <span class="n">forceUpdate</span><span class="p">:</span>
            <span class="n">LocationManager</span><span class="o">.</span><span class="n">downloadBackupFileFromGitHub</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">LocationContext</span><span class="o">.</span><span class="n">db_filename</span><span class="p">,</span>
                                                         <span class="n">targetDirectory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">storageConfig</span><span class="o">.</span><span class="n">getCachePath</span><span class="p">(),</span>
                                                         <span class="n">force</span><span class="o">=</span><span class="n">forceUpdate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadDB</span><span class="p">()</span>
        
            
    <span class="k">def</span> <span class="nf">populate_Version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlDB</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        populate the version table</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            sqlDB(SQLDB): target SQL database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">versionList</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;version&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dbVersion</span><span class="p">}]</span>
        <span class="n">entityInfo</span> <span class="o">=</span> <span class="n">sqlDB</span><span class="o">.</span><span class="n">createTable</span><span class="p">(</span><span class="n">versionList</span><span class="p">,</span> <span class="s2">&quot;Version&quot;</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="n">withDrop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sqlDB</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">versionList</span><span class="p">,</span> <span class="n">entityInfo</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">readCSV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        read the given CSV file</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fileName(str): the filename to read</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cur_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">csvfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cur_dir</span><span class="si">}</span><span class="s2">/data/</span><span class="si">{</span><span class="n">fileName</span><span class="si">}</span><span class="s2">&quot;</span> 
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span>
        
    <span class="k">def</span> <span class="nf">getAliases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the aliases hashTable</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readCSV</span><span class="p">(</span><span class="s2">&quot;aliases.csv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">alias</span><span class="p">[</span><span class="s1">&#39;alias&#39;</span><span class="p">]</span>
        
           
    <span class="k">def</span> <span class="nf">populate_Countries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlDB</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        populate database with countries from wikiData</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            sqlDB(SQLDB): target SQL database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wikidata</span> <span class="o">=</span> <span class="n">Wikidata</span><span class="p">()</span>
        <span class="n">countryList</span><span class="o">=</span><span class="n">wikidata</span><span class="o">.</span><span class="n">getCountries</span><span class="p">()</span>
        <span class="n">wikidata</span><span class="o">.</span><span class="n">store2DB</span><span class="p">(</span><span class="n">countryList</span><span class="p">,</span> <span class="s2">&quot;countries&quot;</span><span class="p">,</span><span class="n">primaryKey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sqlDB</span><span class="o">=</span><span class="n">sqlDB</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">populate_Regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlDB</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        populate database with regions from wikiData</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            sqlDB(SQLDB): target SQL database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wikidata</span> <span class="o">=</span> <span class="n">Wikidata</span><span class="p">()</span>
        <span class="n">regionList</span><span class="o">=</span><span class="n">wikidata</span><span class="o">.</span><span class="n">getRegions</span><span class="p">()</span>
        <span class="n">wikidata</span><span class="o">.</span><span class="n">store2DB</span><span class="p">(</span><span class="n">regionList</span><span class="p">,</span> <span class="s2">&quot;regions&quot;</span><span class="p">,</span> <span class="n">primaryKey</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sqlDB</span><span class="o">=</span><span class="n">sqlDB</span><span class="p">)</span>
   
    <span class="k">def</span> <span class="nf">populate_Cities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlDB</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        populate the given sqlDB with the Wikidata Cities</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            sqlDB(SQLDB): target SQL database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#wikidata = Wikidata()</span>
        <span class="c1">#wikidata.endpoint=&quot;https://confident.dbis.rwth-aachen.de/jena/wdhs/sparql&quot;</span>
        <span class="c1">#cityList=wikidata.getCities()</span>
        <span class="c1">#wikidata.store2DB(cityList, &quot;cities&quot;,primaryKey=None,sqlDB=sqlDB)</span>
        <span class="n">config</span><span class="o">=</span><span class="n">LocationContext</span><span class="o">.</span><span class="n">getDefaultConfig</span><span class="p">()</span>
        <span class="n">regionManager</span> <span class="o">=</span> <span class="n">RegionManager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">regionManager</span><span class="o">.</span><span class="n">fromCache</span><span class="p">()</span>
        <span class="n">regionByIso</span><span class="p">,</span><span class="n">_dup</span><span class="o">=</span><span class="n">regionManager</span><span class="o">.</span><span class="n">getLookup</span><span class="p">(</span><span class="s2">&quot;iso&quot;</span><span class="p">)</span>
        <span class="n">jsonFiles</span><span class="o">=</span><span class="n">CityManager</span><span class="o">.</span><span class="n">getJsonFiles</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;reading </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">jsonFiles</span><span class="p">)</span><span class="si">}</span><span class="s2"> cached city by region JSON cache files&quot;</span>
        <span class="n">profiler</span><span class="o">=</span><span class="n">Profiler</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">cityManager</span><span class="o">=</span><span class="n">CityManager</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="n">cityManager</span><span class="o">.</span><span class="n">getList</span><span class="p">()</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">jsonFileName</span> <span class="ow">in</span> <span class="n">jsonFiles</span><span class="p">:</span>
            <span class="n">isoMatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/([^\/]*)\.json&quot;</span><span class="p">,</span> <span class="n">jsonFileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isoMatch</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jsonFileName</span><span class="si">}</span><span class="s2"> - does not match a known region&#39;s ISO code&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rIso</span><span class="o">=</span><span class="n">isoMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">region</span><span class="o">=</span><span class="n">regionByIso</span><span class="p">[</span><span class="n">rIso</span><span class="p">]</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonFileName</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonFile</span><span class="p">:</span>
                    <span class="n">cities4Region</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonFile</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">city4Region</span> <span class="ow">in</span> <span class="n">cities4Region</span><span class="p">:</span>
                        <span class="n">city</span><span class="o">=</span><span class="n">City</span><span class="p">()</span>
                        <span class="n">city</span><span class="o">.</span><span class="n">fromDict</span><span class="p">(</span><span class="n">city4Region</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="s2">&quot;regionId&quot;</span><span class="p">):</span>
                            <span class="n">city</span><span class="o">.</span><span class="n">partOfRegionId</span><span class="o">=</span><span class="n">city</span><span class="o">.</span><span class="n">regionId</span>
                        <span class="n">city</span><span class="o">.</span><span class="n">regionId</span><span class="o">=</span><span class="n">region</span><span class="o">.</span><span class="n">wikidataid</span>
                        <span class="n">cityManager</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">city</span><span class="p">)</span>
                        <span class="k">pass</span>
        <span class="n">cityManager</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">profiler</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">createViews</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqlDB</span><span class="p">):</span>
        <span class="n">viewDDLs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DROP VIEW IF EXISTS CityLookup&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE VIEW CityLookup AS</span>
<span class="s2">            SELECT </span>
<span class="s2">               cl.label,</span>
<span class="s2">               ci.*,</span>
<span class="s2">               r.name as regionName ,r.iso as regionIso ,r.pop as regionPop,r.lat as regionLat, r.lon as regionLon,</span>
<span class="s2">               c.name as countryName,c.iso as countryIso,c.lat as CountryLat, c.lon as CountryLon</span>
<span class="s2">            FROM </span>
<span class="s2">            city_labels cl</span>
<span class="s2">            JOIN cities ci on ci.wikidataid=cl.wikidataid</span>
<span class="s2">            JOIN regions r on ci.regionId=r.wikidataid</span>
<span class="s2">            JOIN countries c on ci.countryId=c.wikidataid</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;DROP VIEW IF EXISTS RegionLookup&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;CREATE VIEW RegionLookup AS</span>
<span class="sd">            SELECT </span>
<span class="sd">               rl.label,</span>
<span class="sd">               r.*,</span>
<span class="sd">               c.name as countryName,c.iso as countryIso,c.lat as CountryLat, c.lon as CountryLon</span>
<span class="sd">            FROM </span>
<span class="sd">            region_labels rl</span>
<span class="sd">            JOIN regions r on rl.wikidataid=r.wikidataid</span>
<span class="sd">            JOIN countries c on r.countryId=c.wikidataid</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;DROP VIEW IF EXISTS CountryLookup&quot;</span><span class="p">,</span>
            <span class="sd">&quot;&quot;&quot;CREATE VIEW CountryLookup AS</span>
<span class="sd">            SELECT </span>
<span class="sd">               cl.label,</span>
<span class="sd">               c.*</span>
<span class="sd">            FROM </span>
<span class="sd">            country_labels cl</span>
<span class="sd">            JOIN countries c on cl.wikidataid=c.wikidataid</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DROP INDEX if EXISTS cityLabelByWikidataid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX cityLabelByWikidataid ON city_labels (wikidataid)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DROP INDEX if EXISTS cityByWikidataid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX cityByWikidataid ON cities (wikidataid)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DROP INDEX IF EXISTS cityByRegion&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX cityByRegion ON cities (regionId)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DROP INDEX IF EXISTS regionByCountry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;CREATE INDEX regionByCountry ON regions (countryId)&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">viewDDL</span> <span class="ow">in</span> <span class="n">viewDDLs</span><span class="p">:</span>
            <span class="n">sqlDB</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">viewDDL</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">db_recordCount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tableList</span><span class="p">,</span> <span class="n">tableName</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        count the number of records for the given tableName</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            tableList(list): the list of table to check</span>
<span class="sd">            tableName(str): the name of the table to check</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">            int: the number of records found for the table </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tableFound</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tableList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">tableName</span><span class="p">:</span>
                <span class="n">tableFound</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">tableFound</span><span class="p">:</span> 
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT Count(*) AS count FROM </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tableName</span>
            <span class="n">countResult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">countResult</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">count</span>
     
    <span class="k">def</span> <span class="nf">db_has_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        check whether the database has data / is populated</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            boolean: True if the cities table exists and has more than one record</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tableList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="o">.</span><span class="n">getTableList</span><span class="p">()</span>
        <span class="n">hasCities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_recordCount</span><span class="p">(</span><span class="n">tableList</span><span class="p">,</span><span class="s2">&quot;cities&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">200000</span>
        <span class="n">hasCountries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_recordCount</span><span class="p">(</span><span class="n">tableList</span><span class="p">,</span> <span class="s2">&quot;countries&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span>
        <span class="n">hasRegions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_recordCount</span><span class="p">(</span><span class="n">tableList</span><span class="p">,</span> <span class="s2">&quot;regions&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3000</span>
        <span class="n">hasVersion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_recordCount</span><span class="p">(</span><span class="n">tableList</span><span class="p">,</span> <span class="s2">&quot;Version&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">versionOk</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">hasVersion</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT version from Version&quot;</span>
            <span class="n">dbVersionList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">versionOk</span> <span class="o">=</span> <span class="n">dbVersionList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbVersion</span>
        <span class="c1"># hasWikidataCities=self.db_recordCount(tableList,&#39;City_wikidata&#39;)&gt;100000</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">hasVersion</span> <span class="ow">and</span> <span class="n">versionOk</span> <span class="ow">and</span> <span class="n">hasCities</span> <span class="ow">and</span> <span class="n">hasRegions</span> <span class="ow">and</span> <span class="n">hasCountries</span>
        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">def</span> <span class="nf">loadDB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        loads the database from cache and sets it as sqlDB property</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqlDB</span> <span class="o">=</span> <span class="n">SQLDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_file</span><span class="p">,</span> <span class="n">errorDebug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

