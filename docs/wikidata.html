---

title: geograpy3.wikidata


keywords: fastai
sidebar: home_sidebar



nb_path: "004_wikidata.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 004_wikidata.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Main-geograpy3-module">Main geograpy3 module<a class="anchor-link" href="#Main-geograpy3-module"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Wikidata" class="doc_header"><code>class</code> <code>Wikidata</code><a href="https://github.com/somnathrakshit/geograpy_new/tree/master/geograpy_new/wikidata.py#L11" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Wikidata</code>(<strong><code>endpoint</code></strong>=<em><code>'https://query.wikidata.org/sparql'</code></em>, <strong><code>profile</code></strong>:<code>bool</code>=<em><code>True</code></em>)</p>
</blockquote>
<p>Wikidata access</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Wikidata</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Wikidata access</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;https://query.wikidata.org/sparql&#39;</span><span class="p">,</span><span class="n">profile</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="o">=</span><span class="n">profile</span>
        
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="n">queryString</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">list</span><span class="p">:</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the query result</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            msg(str): the profile message to display</span>
<span class="sd">            queryString(str): the query to execute</span>
<span class="sd">            </span>
<span class="sd">        Return:</span>
<span class="sd">            list: the list of dicts with the result</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">profile</span><span class="o">=</span><span class="n">Profiler</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">profile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
        <span class="n">wd</span><span class="o">=</span><span class="n">SPARQL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">)</span>
        <span class="n">limitedQuery</span><span class="o">=</span><span class="n">queryString</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">limitedQuery</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">queryString</span><span class="si">}</span><span class="s2"> LIMIT </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">results</span><span class="o">=</span><span class="n">wd</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">limitedQuery</span><span class="p">)</span>
        <span class="n">lod</span><span class="o">=</span><span class="n">wd</span><span class="o">.</span><span class="n">asListOfDicts</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">lod</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">value</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http://www.wikidata.org/&quot;</span><span class="p">):</span>
                        <span class="n">record</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getWikidataId</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;coord&quot;</span><span class="p">):</span>
                        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">Wikidata</span><span class="o">.</span><span class="n">getCoordinateComponents</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">lat</span>
                        <span class="n">record</span><span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">lon</span>
                        <span class="n">record</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            
                        
        <span class="n">profile</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lod</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lod</span>
    
    <span class="k">def</span> <span class="nf">store2DB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lod</span><span class="p">,</span><span class="n">tableName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="n">primaryKey</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">sqlDB</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        store the given list of dicts to the database</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            lod(list): the list of dicts</span>
<span class="sd">            tableName(str): the table name to use</span>
<span class="sd">            primaryKey(str): primary key (if any)</span>
<span class="sd">            sqlDB(SQLDB): target SQL database</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Storing </span><span class="si">{</span><span class="n">tableName</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">profile</span><span class="o">=</span><span class="n">Profiler</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="n">profile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
        <span class="n">entityInfo</span> <span class="o">=</span> <span class="n">sqlDB</span><span class="o">.</span><span class="n">createTable</span><span class="p">(</span><span class="n">lod</span><span class="p">,</span> <span class="n">entityName</span><span class="o">=</span><span class="n">tableName</span><span class="p">,</span> <span class="n">primaryKey</span><span class="o">=</span><span class="n">primaryKey</span><span class="p">,</span> <span class="n">withDrop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sampleRecordCount</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sqlDB</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">lod</span><span class="p">,</span> <span class="n">entityInfo</span><span class="p">,</span> <span class="n">fixNone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">getCountries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get a list of countries</span>
<span class="sd">        </span>
<span class="sd">        `try query &lt;https://query.wikidata.org/#%23%20get%20a%20list%20of%20countries%0A%23%20for%20geograpy3%20library%0A%23%20see%20https%3A%2F%2Fgithub.com%2Fsomnathrakshit%2Fgeograpy3%2Fissues%2F15%0APREFIX%20rdfs%3A%20%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0APREFIX%20wd%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fentity%2F%3E%0APREFIX%20wdt%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fprop%2Fdirect%2F%3E%0APREFIX%20p%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fprop%2F%3E%0APREFIX%20ps%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fprop%2Fstatement%2F%3E%0APREFIX%20pq%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fprop%2Fqualifier%2F%3E%0A%23%20get%20City%20details%20with%20Country%0ASELECT%20DISTINCT%20%3Fcountry%20%3FcountryLabel%20%3FcountryIsoCode%20%3FcountryPopulation%20%3FcountryGDP_perCapita%20%3Fcoord%20%20WHERE%20%7B%0A%20%20%23%20instance%20of%20City%20Country%0A%20%20%3Fcountry%20wdt%3AP31%2Fwdt%3AP279%2a%20wd%3AQ3624078%20.%0A%20%20%23%20label%20for%20the%20country%0A%20%20%3Fcountry%20rdfs%3Alabel%20%3FcountryLabel%20filter%20%28lang%28%3FcountryLabel%29%20%3D%20%22en%22%29.%0A%20%20%23%20get%20the%20coordinates%0A%20%20%3Fcountry%20wdt%3AP625%20%3Fcoord.%0A%20%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP297%20ISO%203166-1%20alpha-2%20code%0A%20%20%3Fcountry%20wdt%3AP297%20%3FcountryIsoCode.%0A%20%20%23%20population%20of%20country%0A%20%20%3Fcountry%20wdt%3AP1082%20%3FcountryPopulation.%0A%20%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP2132%0A%20%20%23%20nonminal%20GDP%20per%20capita%0A%20%20%3Fcountry%20wdt%3AP2132%20%3FcountryGDP_perCapita.%0A%7D&gt;`_</span>
<span class="sd">      </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queryString</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;# get a list of countries</span>
<span class="s2">            # for geograpy3 library</span>
<span class="s2">            # see https://github.com/somnathrakshit/geograpy3/issues/15</span>
<span class="s2">            PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>
<span class="s2">            PREFIX wd: &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">            PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">            PREFIX p: &lt;http://www.wikidata.org/prop/&gt;</span>
<span class="s2">            PREFIX ps: &lt;http://www.wikidata.org/prop/statement/&gt;</span>
<span class="s2">            PREFIX pq: &lt;http://www.wikidata.org/prop/qualifier/&gt;</span>
<span class="s2">            # get City details with Country</span>
<span class="s2">            SELECT DISTINCT ?wikidataid ?name ?iso ?pop ?coord</span>
<span class="s2">            WHERE {</span>
<span class="s2">            BIND (?countryQ AS ?wikidataid)</span>
<span class="s2">            # instance of Country</span>
<span class="s2">            # inverse path see https://www.wikidata.org/wiki/Wikidata:SPARQL_query_service/query_optimization#Inverse_property_paths</span>
<span class="s2">            wd:Q6256 ^wdt:P279*/^wdt:P31 ?countryQ .</span>

<span class="s2">            # VALUES ?country { wd:Q55}.</span>
<span class="s2">            # label for the country</span>
<span class="s2">            ?countryQ rdfs:label ?name filter (lang(?name) = &quot;en&quot;).</span>
<span class="s2">            # get the continent (s)</span>
<span class="s2">            #OPTIONAL {</span>
<span class="s2">            #  ?country wdt:P30 ?continent.</span>
<span class="s2">            #  ?continent rdfs:label ?continentLabel filter (lang(?continentLabel) = &quot;en&quot;).</span>
<span class="s2">            #}</span>
<span class="s2">            # get the coordinates</span>
<span class="s2">            OPTIONAL { </span>
<span class="s2">              ?countryQ wdt:P625 ?coord.</span>
<span class="s2">            } </span>
<span class="s2">            # https://www.wikidata.org/wiki/Property:P297 ISO 3166-1 alpha-2 code</span>
<span class="s2">            ?countryQ wdt:P297 ?iso.</span>
<span class="s2">            # population of country   </span>
<span class="s2">            OPTIONAL</span>
<span class="s2">            { </span>
<span class="s2">            SELECT ?countryQ (max(?countryPopulationValue) as ?pop)</span>
<span class="s2">            WHERE {</span>
<span class="s2">              ?countryQ wdt:P1082 ?countryPopulationValue</span>
<span class="s2">            } group by ?countryQ</span>
<span class="s2">            }</span>
<span class="s2">            # https://www.wikidata.org/wiki/Property:P2132</span>
<span class="s2">            # nominal GDP per capita</span>
<span class="s2">            # OPTIONAL { ?country wdt:P2132 ?countryGDP_perCapitaValue. }</span>
<span class="s2">            }</span>
<span class="s2">            ORDER BY ?iso&quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Getting countries from wikidata ETA 10s&quot;</span>
        <span class="n">countryList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">queryString</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">countryList</span>

    <span class="k">def</span> <span class="nf">getRegions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get Regions from Wikidata</span>
<span class="sd">        </span>
<span class="sd">        `try query &lt;https://query.wikidata.org/#%23%20get%20a%20list%20of%20regions%0A%23%20for%20geograpy3%20library%0A%23%20see%20https%3A%2F%2Fgithub.com%2Fsomnathrakshit%2Fgeograpy3%2Fissues%2F15%0APREFIX%20rdfs%3A%20%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0APREFIX%20wd%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fentity%2F%3E%0APREFIX%20wdt%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fprop%2Fdirect%2F%3E%0APREFIX%20wikibase%3A%20%3Chttp%3A%2F%2Fwikiba.se%2Fontology%23%3E%0ASELECT%20%3Fcountry%20%3FcountryLabel%20%3FcountryIsoCode%20%3Fregion%20%3FregionIsoCode%20%3FregionLabel%20%3Fpopulation%20%3Flocation%0AWHERE%0A%7B%0A%20%20%23%20administrative%20unit%20of%20first%20order%0A%20%20%3Fregion%20wdt%3AP31%2Fwdt%3AP279%2a%20wd%3AQ10864048.%0A%20%20OPTIONAL%20%7B%0A%20%20%20%20%20%3Fregion%20rdfs%3Alabel%20%3FregionLabel%20filter%20%28lang%28%3FregionLabel%29%20%3D%20%22en%22%29.%0A%20%20%7D%0A%20%20%23%20filter%20historic%20regions%0A%20%20%23%20FILTER%20NOT%20EXISTS%20%7B%3Fregion%20wdt%3AP576%20%3Fend%7D%0A%20%20%23%20get%20the%20population%0A%20%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP1082%0A%20%20OPTIONAL%20%7B%20%3Fregion%20wdt%3AP1082%20%3Fpopulation.%20%7D%0A%20%20%23%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP297%0A%20%20OPTIONAL%20%7B%20%0A%20%20%20%20%3Fregion%20wdt%3AP17%20%3Fcountry.%0A%20%20%20%20%23%20label%20for%20the%20country%0A%20%20%20%20%3Fcountry%20rdfs%3Alabel%20%3FcountryLabel%20filter%20%28lang%28%3FcountryLabel%29%20%3D%20%22en%22%29.%0A%20%20%20%20%3Fcountry%20wdt%3AP297%20%3FcountryIsoCode.%20%0A%20%20%7D%0A%20%20%23%20isocode%20state%2Fprovince%0A%20%20%3Fregion%20wdt%3AP300%20%3FregionIsoCode.%0A%20%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP625%0A%20%20OPTIONAL%20%7B%20%3Fregion%20wdt%3AP625%20%3Flocation.%20%7D%0A%7D&gt;`_</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queryString</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;# get a list of regions</span>
<span class="s2">            # for geograpy3 library</span>
<span class="s2">            # see https://github.com/somnathrakshit/geograpy3/issues/15</span>
<span class="s2">            PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>
<span class="s2">            PREFIX wd: &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">            PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">            PREFIX wikibase: &lt;http://wikiba.se/ontology#&gt;</span>
<span class="s2">            SELECT DISTINCT ?countryId (?regionQ as ?wikidataid) ?name ?iso ?pop ?coord</span>
<span class="s2">            WHERE</span>
<span class="s2">            {</span>
<span class="s2">              # administrative unit of first order</span>
<span class="s2">              ?regionQ wdt:P31/wdt:P279* wd:Q10864048.</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                 ?regionQ rdfs:label ?name filter (lang(?name) = &quot;en&quot;).</span>
<span class="s2">              }</span>
<span class="s2">              # isocode state/province (mandatory - filters historic regions while at it ...)</span>
<span class="s2">              # filter historic regions</span>
<span class="s2">              # FILTER NOT EXISTS {?region wdt:P576 ?end}</span>
<span class="s2">              { </span>
<span class="s2">                SELECT ?regionQ (max(?regionAlpha2) as ?iso) (max(?regionPopulationValue) as ?pop) (max(?locationValue) as ?coord)</span>
<span class="s2">                WHERE {</span>
<span class="s2">                  ?regionQ wdt:P300 ?regionAlpha2.</span>
<span class="s2">                  # get the population</span>
<span class="s2">                  # https://www.wikidata.org/wiki/Property:P1082</span>
<span class="s2">                  OPTIONAL {</span>
<span class="s2">                    ?regionQ wdt:P1082 ?regionPopulationValue</span>
<span class="s2">                  } </span>
<span class="s2">                  # get the location</span>
<span class="s2">                  # https://www.wikidata.org/wiki/Property:P625</span>
<span class="s2">                  OPTIONAL {</span>
<span class="s2">                    ?regionQ wdt:P625 ?locationValue. </span>
<span class="s2">                   }</span>
<span class="s2">                } GROUP BY ?regionQ</span>
<span class="s2">              }</span>
<span class="s2">              # # https://www.wikidata.org/wiki/Property:P297</span>
<span class="s2">              OPTIONAL { </span>
<span class="s2">                ?regionQ wdt:P17 ?countryId.</span>
<span class="s2">              }</span>
<span class="s2">            } ORDER BY ?iso&quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Getting regions from wikidata ETA 15s&quot;</span>
        <span class="n">regionList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">queryString</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">regionList</span>

        
    <span class="k">def</span> <span class="nf">getCities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get all human settlements as list of dict with duplicates for label, region, country ...</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queryString</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>
<span class="s2">            PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">            PREFIX wd: &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">            PREFIX skos: &lt;http://www.w3.org/2004/02/skos/core#&gt;</span>
<span class="s2">            SELECT DISTINCT (?cityQ as ?wikidataid) ?city ?altLabel ?geoNameId ?gndId ?cityPopulation ?cityCoord ?regionId ?countryId</span>
<span class="s2">            WHERE {</span>
<span class="s2">              # instance of human settlement https://www.wikidata.org/wiki/Q486972</span>
<span class="s2">              wd:Q486972 ^wdt:P279*/^wdt:P31 ?cityQ .</span>
<span class="s2">              # Values</span>
<span class="s2">              # VALUES  ?cityQ { wd:Q656 }</span>

<span class="s2">              # label of the City</span>
<span class="s2">              ?cityQ rdfs:label ?city filter (lang(?city) = &quot;en&quot;).</span>

<span class="s2">              OPTIONAL {</span>
<span class="s2">                 ?cityQ skos:altLabel ?altLabel .</span>
<span class="s2">                 FILTER (lang(?altLabel) = &quot;en&quot;)</span>
<span class="s2">              }</span>

<span class="s2">              # geoName Identifier</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                  ?cityQ wdt:P1566 ?geoNameId.</span>
<span class="s2">              }</span>
<span class="s2">              # GND-ID</span>
<span class="s2">              OPTIONAL { </span>
<span class="s2">                  ?cityQ wdt:P227 ?gndId. </span>
<span class="s2">              }</span>

<span class="s2">              # population of city</span>
<span class="s2">              OPTIONAL { </span>
<span class="s2">                SELECT ?cityQ (max(?cityPopulationValue) as ?cityPopulation)</span>
<span class="s2">                WHERE {</span>
<span class="s2">                  ?cityQ wdt:P1082 ?cityPopulationValue</span>
<span class="s2">                } group by ?cityQ</span>
<span class="s2">              }</span>

<span class="s2">              OPTIONAL{</span>
<span class="s2">                 ?cityQ wdt:P625 ?cityCoord .</span>
<span class="s2">              }</span>

<span class="s2">              # region this city belongs to</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                ?cityQ wdt:P131 ?regionId .     </span>
<span class="s2">              }</span>
<span class="s2">              # country this city belongs to</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                  ?cityQ wdt:P17 ?countryId .</span>
<span class="s2">              }</span>

<span class="s2">            }</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Getting cities (human settlements) from wikidata ETA 50 s&quot;</span>
        <span class="n">citiesList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">queryString</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">citiesList</span>
    
    <span class="k">def</span> <span class="nf">getCitiesForRegion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">regionId</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get the cities for the given Region</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">regionPath</span><span class="o">=</span><span class="s2">&quot;?region ^wdt:P131/^wdt:P131/^wdt:P131 ?cityQ.&quot;</span> <span class="k">if</span> <span class="n">regionId</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Q980&quot;</span><span class="p">,</span><span class="s2">&quot;Q21&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;?cityQ wdt:P131* ?region.&quot;</span> 
        <span class="n">queryString</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;# get cities by region for geograpy3</span>
<span class="s2">            PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>
<span class="s2">            PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">            PREFIX wd: &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">            SELECT distinct (?cityQ as ?wikidataid) ?name ?geoNameId ?gndId ?regionId ?countryId ?pop ?coord WHERE { </span>
<span class="s2">              VALUES ?hsType {</span>
<span class="s2">                  wd:Q1549591 wd:Q3957 wd:Q5119 wd:Q15284 wd:Q62049 wd:Q515 wd:Q1637706 wd:Q1093829 wd:Q486972 wd:Q532</span>
<span class="s2">              }</span>

<span class="s2">              VALUES ?region {</span>
<span class="s2">                     wd:</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">              }</span>

<span class="s2">              # region the city should be in</span>
<span class="s2">              </span><span class="si">%s</span><span class="s2"></span>

<span class="s2">              # type of human settlement to try</span>
<span class="s2">              ?hsType ^wdt:P279*/^wdt:P31 ?cityQ.</span>

<span class="s2">              # label of the City</span>
<span class="s2">              ?cityQ rdfs:label ?name filter (lang(?name) = &quot;en&quot;).</span>

<span class="s2">              # geoName Identifier</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                  ?cityQ wdt:P1566 ?geoNameId.</span>
<span class="s2">              }</span>
<span class="s2">              # GND-ID</span>
<span class="s2">              OPTIONAL { </span>
<span class="s2">                  ?cityQ wdt:P227 ?gndId. </span>
<span class="s2">              }</span>

<span class="s2">              OPTIONAL{</span>
<span class="s2">                 ?cityQ wdt:P625 ?coord .</span>
<span class="s2">              }</span>

<span class="s2">              # region this city belongs to</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                ?cityQ wdt:P131 ?regionId .     </span>
<span class="s2">              }</span>

<span class="s2">              OPTIONAL {</span>
<span class="s2">                 ?cityQ wdt:P1082 ?pop</span>
<span class="s2">              }</span>
<span class="s2">              # country this city belongs to</span>
<span class="s2">              OPTIONAL {</span>
<span class="s2">                  ?cityQ wdt:P17 ?countryId .</span>
<span class="s2">              }</span>
<span class="s2">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">regionId</span><span class="p">,</span><span class="n">regionPath</span><span class="p">)</span>           
        <span class="n">regionCities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">queryString</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">regionCities</span>

    <span class="k">def</span> <span class="nf">getCityStates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        get city states from Wikidata</span>
<span class="sd">        `try query &lt;https://query.wikidata.org/#%23%20get%20a%20list%20of%20city%20states%0A%23%20for%20geograpy3%20library%0APREFIX%20rdfs%3A%20%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0APREFIX%20wd%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fentity%2F%3E%0APREFIX%20wdt%3A%20%3Chttp%3A%2F%2Fwww.wikidata.org%2Fprop%2Fdirect%2F%3E%0APREFIX%20wikibase%3A%20%3Chttp%3A%2F%2Fwikiba.se%2Fontology%23%3E%0ASELECT%20DISTINCT%20%3FcountryId%20%28%3FcityStateQ%20as%20%3Fwikidataid%29%20%3Fname%20%3Fiso%20%3Fpop%20%3Fcoord%0AWHERE%0A%7B%0A%20%20%23%20all%20citiy%20states%0A%20%20%3FcityStateQ%20wdt%3AP31%20wd%3AQ133442%20.%0A%20%20%3FcityStateQ%20rdfs%3Alabel%20%3Fname%20filter%20%28lang%28%3Fname%29%20%3D%20%22en%22%29.%0A%20%20%7B%20%0A%20%20%20%20SELECT%20%3FcityStateQ%20%28max%28%3FisoCode%29%20as%20%3Fiso%29%20%28max%28%3FpopulationValue%29%20as%20%3Fpop%29%20%28max%28%3FlocationValue%29%20as%20%3Fcoord%29%0A%20%20%20%20WHERE%20%7B%0A%20%20%20%20%20%20%3FcityStateQ%20wdt%3AP300%7Cwdt%3AP297%20%3FisoCode.%0A%20%20%20%20%20%20%23%20get%20the%20population%0A%20%20%20%20%20%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP1082%0A%20%20%20%20%20%20OPTIONAL%20%7B%0A%20%20%20%20%20%20%20%20%3FcityStateQ%20wdt%3AP1082%20%3FpopulationValue%0A%20%20%20%20%20%20%7D%20%0A%20%20%20%20%20%20%23%20get%20the%20location%0A%20%20%20%20%20%20%23%20https%3A%2F%2Fwww.wikidata.org%2Fwiki%2FProperty%3AP625%0A%20%20%20%20%20%20OPTIONAL%20%7B%0A%20%20%20%20%20%20%20%20%3FcityStateQ%20wdt%3AP625%20%3FlocationValue.%20%0A%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20GROUP%20BY%20%3FcityStateQ%0A%20%20%7D%0A%20%20OPTIONAL%20%7B%20%0A%20%20%20%20%3FcityStateQ%20wdt%3AP17%20%3FcountryId.%0A%20%20%7D%0A%7D%20ORDER%20BY%20%3Fiso&gt;`_</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">queryString</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;# get a list of city states</span>
<span class="s2">            # for geograpy3 library</span>
<span class="s2">            PREFIX rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span>
<span class="s2">            PREFIX wd: &lt;http://www.wikidata.org/entity/&gt;</span>
<span class="s2">            PREFIX wdt: &lt;http://www.wikidata.org/prop/direct/&gt;</span>
<span class="s2">            PREFIX wikibase: &lt;http://wikiba.se/ontology#&gt;</span>
<span class="s2">            SELECT DISTINCT ?countryId (?cityStateQ as ?wikidataid) ?name ?iso ?pop ?coord</span>
<span class="s2">            WHERE</span>
<span class="s2">            {</span>
<span class="s2">              # all citiy states</span>
<span class="s2">              ?cityStateQ wdt:P31 wd:Q133442 .</span>
<span class="s2">              ?cityStateQ rdfs:label ?name filter (lang(?name) = &quot;en&quot;).</span>
<span class="s2">              { </span>
<span class="s2">                SELECT ?cityStateQ (max(?isoCode) as ?iso) (max(?populationValue) as ?pop) (max(?locationValue) as ?coord)</span>
<span class="s2">                WHERE {</span>
<span class="s2">                  ?cityStateQ wdt:P300|wdt:P297 ?isoCode.</span>
<span class="s2">                  # get the population</span>
<span class="s2">                  # https://www.wikidata.org/wiki/Property:P1082</span>
<span class="s2">                  OPTIONAL {</span>
<span class="s2">                    ?cityStateQ wdt:P1082 ?populationValue</span>
<span class="s2">                  } </span>
<span class="s2">                  # get the location</span>
<span class="s2">                  # https://www.wikidata.org/wiki/Property:P625</span>
<span class="s2">                  OPTIONAL {</span>
<span class="s2">                    ?cityStateQ wdt:P625 ?locationValue. </span>
<span class="s2">                   }</span>
<span class="s2">                } GROUP BY ?cityStateQ</span>
<span class="s2">              }</span>
<span class="s2">              OPTIONAL { </span>
<span class="s2">                ?cityStateQ wdt:P17 ?countryId.</span>
<span class="s2">              }</span>
<span class="s2">            } ORDER BY ?iso&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Getting regions from wikidata ETA 15s&quot;</span>
        <span class="n">cityStateList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">queryString</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cityStateList</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getCoordinateComponents</span><span class="p">(</span><span class="n">coordinate</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Converts the wikidata coordinate representation into its subcomponents longitude and latitude</span>
<span class="sd">        Example: &#39;Point(-118.25 35.05694444)&#39; results in (&#39;-118.25&#39; &#39;35.05694444&#39;)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            coordinate: coordinate value in the format as returned by wikidata queries</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Returns the longitude and latitude of the given coordinate as separate values</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># https://stackoverflow.com/a/18237992/1497139</span>
        <span class="n">floatRegex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d+([.,]\d*)?&quot;</span>
        <span class="n">regexp</span><span class="o">=</span><span class="sa">fr</span><span class="s2">&quot;Point\((?P&lt;lon&gt;</span><span class="si">{</span><span class="n">floatRegex</span><span class="si">}</span><span class="s2">)\s+(?P&lt;lat&gt;</span><span class="si">{</span><span class="n">floatRegex</span><span class="si">}</span><span class="s2">)\)&quot;</span>
        <span class="n">cMatch</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">coordinate</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cMatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="c1"># ignore</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">cMatch</span><span class="p">:</span>
            <span class="n">latStr</span><span class="o">=</span><span class="n">cMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
            <span class="n">lonStr</span><span class="o">=</span><span class="n">cMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">)</span>
            <span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">latStr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="s2">&quot;.&quot;</span><span class="p">)),</span><span class="nb">float</span><span class="p">(</span><span class="n">lonStr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span><span class="s2">&quot;.&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">lon</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span>
                <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="o">-</span><span class="mi">360</span>
            <span class="k">return</span> <span class="n">lat</span><span class="p">,</span><span class="n">lon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># coordinate does not have the expected format</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getWikidataId</span><span class="p">(</span><span class="n">wikidataURL</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extracts the wikidata id from the given wikidata URL</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            wikidataURL: wikidata URL the id should be extracted from</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            The wikidata id if present in the given wikidata URL otherwise None</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># regex pattern taken from https://www.wikidata.org/wiki/Q43649390 and extended to also support property ids</span>
        <span class="n">wikidataidMatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[PQ][1-9]\d*&quot;</span><span class="p">,</span> <span class="n">wikidataURL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wikidataidMatch</span> <span class="ow">and</span> <span class="n">wikidataidMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">wikidataid</span> <span class="o">=</span> <span class="n">wikidataidMatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wikidataid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">getValuesClause</span><span class="p">(</span><span class="n">varName</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">wikidataEntities</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        generates the SPARQL value clause for the given variable name containing the given values</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            varName: variable name for the ValuesClause</span>
<span class="sd">            values: values for the clause</span>
<span class="sd">            wikidataEntities(bool): if true the wikidata prefix is added to the values otherwise it is expected taht the given values are proper IRIs</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">clauseValues</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wikidataEntities</span><span class="p">:</span>
                    <span class="n">clauseValues</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;wd:</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clauseValues</span><span class="o">+=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wikidataEntities</span><span class="p">:</span>
                <span class="n">clauseValues</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;wd:</span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clauseValues</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">clause</span> <span class="o">=</span> <span class="s2">&quot;VALUES ?</span><span class="si">%s</span><span class="s2"> { </span><span class="si">%s</span><span class="s2"> }&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">varName</span><span class="p">,</span> <span class="n">clauseValues</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">clause</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

